var Kinetic={};Kinetic.Filters={},Kinetic.Plugins={},Kinetic.Global={BUFFER_WHITELIST:["fill","stroke","textFill","textStroke"],BUFFER_BLACKLIST:["shadow"],stages:[],idCounter:0,tempNodes:{},shapes:{},warn:function(b){window.console&&console.warn&&console.warn("Kinetic warning: "+b)},extend:function(e,d){for(var f in d.prototype){f in e.prototype||(e.prototype[f]=d.prototype[f])}},_pullNodes:function(f){var e=this.tempNodes;for(var h in e){var g=e[h];g.getStage()!==undefined&&g.getStage()._id===f._id&&(f._addId(g),f._addName(g),this._removeTempNode(g))}},_addTempNode:function(b){this.tempNodes[b._id]=b},_removeTempNode:function(b){delete this.tempNodes[b._id]}},Kinetic.Type={_isElement:function(b){return !!b&&b.nodeType==1},_isFunction:function(b){return !!(b&&b.constructor&&b.call&&b.apply)},_isObject:function(b){return !!b&&b.constructor==Object},_isArray:function(b){return Object.prototype.toString.call(b)=="[object Array]"},_isNumber:function(b){return Object.prototype.toString.call(b)=="[object Number]"},_isString:function(b){return Object.prototype.toString.call(b)=="[object String]"},_hasMethods:function(e){var d=[];for(var f in e){this._isFunction(e[f])&&d.push(f)}return d.length>0},_getXY:function(d){if(this._isNumber(d)){return{x:d,y:d}}if(this._isArray(d)){if(d.length===1){var c=d[0];if(this._isNumber(c)){return{x:c,y:c}}if(this._isArray(c)){return{x:c[0],y:c[1]}}if(this._isObject(c)){return c}}else{if(d.length>=2){return{x:d[0],y:d[1]}}}}else{if(this._isObject(d)){return d}}return{x:0,y:0}},_getSize:function(d){if(this._isNumber(d)){return{width:d,height:d}}if(this._isArray(d)){if(d.length===1){var c=d[0];if(this._isNumber(c)){return{width:c,height:c}}if(this._isArray(c)){if(c.length>=4){return{width:c[2],height:c[3]}}if(c.length>=2){return{width:c[0],height:c[1]}}}else{if(this._isObject(c)){return c}}}else{if(d.length>=4){return{width:d[2],height:d[3]}}if(d.length>=2){return{width:d[0],height:d[1]}}}}else{if(this._isObject(d)){return d}}return{width:0,height:0}},_getPoints:function(e){if(e===undefined){return[]}if(this._isObject(e[0])){return e}var d=[];for(var f=0;f<e.length;f+=2){d.push({x:e[f],y:e[f+1]})}return d},_getImage:function(h,g){if(!h){g(null)}else{if(this._isElement(h)){g(h)}else{if(this._isString(h)){var l=new Image;l.onload=function(){g(l)},l.src=h}else{if(h.data){var k=document.createElement("canvas");k.width=h.width,k.height=h.height;var j=k.getContext("2d");j.putImageData(h,0,0);var i=k.toDataURL(),l=new Image;l.onload=function(){g(l)},l.src=i}else{g(null)}}}}},_rgbToHex:function(e,d,f){return((1<<24)+(e<<16)+(d<<8)+f).toString(16).slice(1)},_hexToRgb:function(d){var c=parseInt(d,16);return{r:c>>16&255,g:c>>8&255,b:c&255}},_getRandomColorKey:function(){var e=Math.round(Math.random()*255),d=Math.round(Math.random()*255),f=Math.round(Math.random()*255);return this._rgbToHex(e,d,f)},_merge:function(f,e){var h=this._clone(e);for(var g in f){this._isObject(f[g])?h[g]=this._merge(f[g],h[g]):h[g]=f[g]}return h},_clone:function(e){var d={};for(var f in e){this._isObject(e[f])?d[f]=this._clone(e[f]):d[f]=e[f]}return d}},Kinetic.Canvas=function(d,c){this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.element.width=d,this.element.height=c},Kinetic.Canvas.prototype={clear:function(){var d=this.getContext(),c=this.getElement();d.clearRect(0,0,c.width,c.height)},getElement:function(){return this.element},getContext:function(){return this.context},setWidth:function(b){this.element.width=b},setHeight:function(b){this.element.height=b},getWidth:function(){return this.element.width},getHeight:function(){return this.element.height},setSize:function(d,c){this.setWidth(d),this.setHeight(c)},toDataURL:function(e,d){try{return this.element.toDataURL(e,d)}catch(f){return this.element.toDataURL()}}},Kinetic.Tween=function(h,g,l,k,j,i){this._listeners=[],this.addListener(this),this.obj=h,this.propFunc=g,this.begin=k,this._pos=k,this.setDuration(i),this.isPlaying=!1,this._change=0,this.prevTime=0,this.prevPos=0,this.looping=!1,this._time=0,this._position=0,this._startTime=0,this._finish=0,this.name="",this.func=l,this.setFinish(j)},Kinetic.Tween.prototype={setTime:function(b){this.prevTime=this._time,b>this.getDuration()?this.looping?(this.rewind(b-this._duration),this.update(),this.broadcastMessage("onLooped",{target:this,type:"onLooped"})):(this._time=this._duration,this.update(),this.stop(),this.broadcastMessage("onFinished",{target:this,type:"onFinished"})):b<0?(this.rewind(),this.update()):(this._time=b,this.update())},getTime:function(){return this._time},setDuration:function(b){this._duration=b===null||b<=0?100000:b},getDuration:function(){return this._duration},setPosition:function(b){this.prevPos=this._pos,this.propFunc(b),this._pos=b,this.broadcastMessage("onChanged",{target:this,type:"onChanged"})},getPosition:function(b){return b===undefined&&(b=this._time),this.func(b,this.begin,this._change,this._duration)},setFinish:function(b){this._change=b-this.begin},getFinish:function(){return this.begin+this._change},start:function(){this.rewind(),this.startEnterFrame(),this.broadcastMessage("onStarted",{target:this,type:"onStarted"})},rewind:function(b){this.stop(),this._time=b===undefined?0:b,this.fixTime(),this.update()},fforward:function(){this._time=this._duration,this.fixTime(),this.update()},update:function(){this.setPosition(this.getPosition(this._time))},startEnterFrame:function(){this.stopEnterFrame(),this.isPlaying=!0,this.onEnterFrame()},onEnterFrame:function(){this.isPlaying&&this.nextFrame()},nextFrame:function(){this.setTime((this.getTimer()-this._startTime)/1000)},stop:function(){this.stopEnterFrame(),this.broadcastMessage("onStopped",{target:this,type:"onStopped"})},stopEnterFrame:function(){this.isPlaying=!1},continueTo:function(d,c){this.begin=this._pos,this.setFinish(d),this._duration!==undefined&&this.setDuration(c),this.start()},resume:function(){this.fixTime(),this.startEnterFrame(),this.broadcastMessage("onResumed",{target:this,type:"onResumed"})},yoyo:function(){this.continueTo(this.begin,this._time)},addListener:function(b){return this.removeListener(b),this._listeners.push(b)},removeListener:function(e){var d=this._listeners,f=d.length;while(f--){if(d[f]==e){return d.splice(f,1),!0}}return !1},broadcastMessage:function(){var g=[];for(var f=0;f<arguments.length;f++){g.push(arguments[f])}var j=g.shift(),i=this._listeners,h=i.length;for(var f=0;f<h;f++){i[f][j]&&i[f][j].apply(i[f],g)}},fixTime:function(){this._startTime=this.getTimer()-this._time*1000},getTimer:function(){return(new Date).getTime()-this._time}},Kinetic.Tweens={"back-ease-in":function(i,h,n,m,l,k){var j=1.70158;return n*(i/=m)*i*((j+1)*i-j)+h},"back-ease-out":function(i,h,n,m,l,k){var j=1.70158;return n*((i=i/m-1)*i*((j+1)*i+j)+1)+h},"back-ease-in-out":function(i,h,n,m,l,k){var j=1.70158;return(i/=m/2)<1?n/2*i*i*(((j*=1.525)+1)*i-j)+h:n/2*((i-=2)*i*(((j*=1.525)+1)*i+j)+2)+h},"elastic-ease-in":function(i,h,n,m,l,k){var j=0;return i===0?h:(i/=m)==1?h+n:(k||(k=m*0.3),!l||l<Math.abs(n)?(l=n,j=k/4):j=k/(2*Math.PI)*Math.asin(n/l),-(l*Math.pow(2,10*(i-=1))*Math.sin((i*m-j)*2*Math.PI/k))+h)},"elastic-ease-out":function(i,h,n,m,l,k){var j=0;return i===0?h:(i/=m)==1?h+n:(k||(k=m*0.3),!l||l<Math.abs(n)?(l=n,j=k/4):j=k/(2*Math.PI)*Math.asin(n/l),l*Math.pow(2,-10*i)*Math.sin((i*m-j)*2*Math.PI/k)+n+h)},"elastic-ease-in-out":function(i,h,n,m,l,k){var j=0;return i===0?h:(i/=m/2)==2?h+n:(k||(k=m*0.3*1.5),!l||l<Math.abs(n)?(l=n,j=k/4):j=k/(2*Math.PI)*Math.asin(n/l),i<1?-0.5*l*Math.pow(2,10*(i-=1))*Math.sin((i*m-j)*2*Math.PI/k)+h:l*Math.pow(2,-10*(i-=1))*Math.sin((i*m-j)*2*Math.PI/k)*0.5+n+h)},"bounce-ease-out":function(f,e,h,g){return(f/=g)<1/2.75?h*7.5625*f*f+e:f<2/2.75?h*(7.5625*(f-=1.5/2.75)*f+0.75)+e:f<2.5/2.75?h*(7.5625*(f-=2.25/2.75)*f+0.9375)+e:h*(7.5625*(f-=2.625/2.75)*f+0.984375)+e},"bounce-ease-in":function(f,e,h,g){return h-Kinetic.Tweens["bounce-ease-out"](g-f,0,h,g)+e},"bounce-ease-in-out":function(f,e,h,g){return f<g/2?Kinetic.Tweens["bounce-ease-in"](f*2,0,h,g)*0.5+e:Kinetic.Tweens["bounce-ease-out"](f*2-g,0,h,g)*0.5+h*0.5+e},"ease-in":function(f,e,h,g){return h*(f/=g)*f+e},"ease-out":function(f,e,h,g){return -h*(f/=g)*(f-2)+e},"ease-in-out":function(f,e,h,g){return(f/=g/2)<1?h/2*f*f+e:-h/2*(--f*(f-2)-1)+e},"strong-ease-in":function(f,e,h,g){return h*(f/=g)*f*f*f*f+e},"strong-ease-out":function(f,e,h,g){return h*((f=f/g-1)*f*f*f*f+1)+e},"strong-ease-in-out":function(f,e,h,g){return(f/=g/2)<1?h/2*f*f*f*f*f+e:h/2*((f-=2)*f*f*f*f+2)+e},linear:function(f,e,h,g){return h*f/g+e}},Kinetic.Transform=function(){this.m=[1,0,0,1,0,0]},Kinetic.Transform.prototype={translate:function(d,c){this.m[4]+=this.m[0]*d+this.m[2]*c,this.m[5]+=this.m[1]*d+this.m[3]*c},scale:function(d,c){this.m[0]*=d,this.m[1]*=d,this.m[2]*=c,this.m[3]*=c},rotate:function(i){var h=Math.cos(i),n=Math.sin(i),m=this.m[0]*h+this.m[2]*n,l=this.m[1]*h+this.m[3]*n,k=this.m[0]*-n+this.m[2]*h,j=this.m[1]*-n+this.m[3]*h;this.m[0]=m,this.m[1]=l,this.m[2]=k,this.m[3]=j},getTranslation:function(){return{x:this.m[4],y:this.m[5]}},multiply:function(i){var h=this.m[0]*i.m[0]+this.m[2]*i.m[1],n=this.m[1]*i.m[0]+this.m[3]*i.m[1],m=this.m[0]*i.m[2]+this.m[2]*i.m[3],l=this.m[1]*i.m[2]+this.m[3]*i.m[3],k=this.m[0]*i.m[4]+this.m[2]*i.m[5]+this.m[4],j=this.m[1]*i.m[4]+this.m[3]*i.m[5]+this.m[5];this.m[0]=h,this.m[1]=n,this.m[2]=m,this.m[3]=l,this.m[4]=k,this.m[5]=j},invert:function(){var i=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]),h=this.m[3]*i,n=-this.m[1]*i,m=-this.m[2]*i,l=this.m[0]*i,k=i*(this.m[2]*this.m[5]-this.m[3]*this.m[4]),j=i*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=h,this.m[1]=n,this.m[2]=m,this.m[3]=l,this.m[4]=k,this.m[5]=j},getMatrix:function(){return this.m}},Kinetic.Collection=function(){var e=[].slice.call(arguments),d=e.length,f=0;this.length=d;for(;f<d;f++){this[f]=e[f]}return this},Kinetic.Collection.prototype=new Array,Kinetic.Collection.prototype.apply=function(d){args=[].slice.call(arguments),args.shift();for(var c=0;c<this.length;c++){Kinetic.Type._isFunction(this[c][d])&&this[c][d].apply(this[c],args)}},Kinetic.Collection.prototype.each=function(d){for(var c=0;c<this.length;c++){d.call(this[c],c,this[c])}},Kinetic.Filters.Grayscale=function(g,f){var j=g.data;for(var i=0;i<j.length;i+=4){var h=0.34*j[i]+0.5*j[i+1]+0.16*j[i+2];j[i]=h,j[i+1]=h,j[i+2]=h}},Kinetic.Filters.Brighten=function(g,f){var j=f.val||0,i=g.data;for(var h=0;h<i.length;h+=4){i[h]+=j,i[h+1]+=j,i[h+2]+=j}},Kinetic.Filters.Invert=function(f,e){var h=f.data;for(var g=0;g<h.length;g+=4){h[g]=255-h[g],h[g+1]=255-h[g+1],h[g+2]=255-h[g+2]}},Kinetic.Animation=function(d){d||(d={});for(var c in d){this[c]=d[c]}this.id=Kinetic.Animation.animIdCounter++},Kinetic.Animation.prototype={start:function(){this.stop(),Kinetic.Animation._addAnimation(this),Kinetic.Animation._handleAnimation()},stop:function(){Kinetic.Animation._removeAnimation(this)}},Kinetic.Animation.animations=[],Kinetic.Animation.animIdCounter=0,Kinetic.Animation.animRunning=!1,Kinetic.Animation.frame={time:0,timeDiff:0,lastTime:(new Date).getTime(),frameRate:0},Kinetic.Animation.fixedRequestAnimFrame=function(b){window.setTimeout(b,1000/60)},Kinetic.Animation._addAnimation=function(b){this.animations.push(b)},Kinetic.Animation._removeAnimation=function(f){var e=f.id,h=this.animations;for(var g=0;g<h.length;g++){if(h[g].id===e){this.animations.splice(g,1);break}}},Kinetic.Animation._updateFrameObject=function(){var b=(new Date).getTime();this.frame.timeDiff=b-this.frame.lastTime,this.frame.lastTime=b,this.frame.time+=this.frame.timeDiff,this.frame.frameRate=1000/this.frame.timeDiff},Kinetic.Animation._runFrames=function(){this._updateFrameObject();var f={};for(var e=0;e<this.animations.length;e++){var h=this.animations[e];h.node&&h.node._id!==undefined&&(f[h.node._id]=h.node),h.func&&h.func(this.frame)}for(var g in f){f[g].draw()}},Kinetic.Animation._animationLoop=function(){if(this.animations.length>0){this._runFrames();var b=this;Kinetic.Animation.requestAnimFrame(function(){b._animationLoop()})}else{this.animRunning=!1}},Kinetic.Animation._handleAnimation=function(){var b=this;this.animRunning||(this.animRunning=!0,b._animationLoop())},Kinetic.Animation.requestAnimFrame=function(d){var c=Kinetic.DD&&Kinetic.DD.moving?this.fixedRequestAnimFrame:window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Kinetic.Animation.fixedRequestAnimFrame;c(d)},Kinetic.Node=function(b){this._nodeInit(b)},Kinetic.Node.prototype={_nodeInit:function(d){this.defaultNodeAttrs={visible:!0,listening:!0,name:undefined,opacity:1,x:0,y:0,scale:{x:1,y:1},rotation:0,offset:{x:0,y:0},draggable:!1},this.setDefaultAttrs(this.defaultNodeAttrs),this.eventListeners={},this.setAttrs(d);var c=this;this.on("idChange.kinetic",function(b){var e=c.getStage();e&&(e._removeId(b.oldVal),e._addId(c))}),this.on("nameChange.kinetic",function(b){var e=c.getStage();e&&(e._removeName(b.oldVal,c._id),e._addName(c))})},on:function(r,q){var p=r.split(" ");for(var o=0;o<p.length;o++){var n=p[o],m=n,l=m.split("."),k=l[0],j=l.length>1?l[1]:"";this.eventListeners[k]||(this.eventListeners[k]=[]),this.eventListeners[k].push({name:j,handler:q})}},off:function(i){var h=i.split(" ");for(var n=0;n<h.length;n++){var m=h[n],l=m,k=l.split("."),j=k[0];if(k.length>1){if(j){this.eventListeners[j]&&this._off(j,k[1])}else{for(var m in this.eventListeners){this._off(m,k[1])}}}else{delete this.eventListeners[j]}}},remove:function(){var d=this.getParent();if(d&&this.index!==undefined&&d.children[this.index]._id==this._id){var c=d.getStage();c&&(c._removeId(this.getId()),c._removeName(this.getName(),this._id)),Kinetic.Global._removeTempNode(this),d.children.splice(this.index,1),d._setChildrenIndices();while(this.children&&this.children.length>0){this.children[0].remove()}}},getAttrs:function(){return this.attrs},setDefaultAttrs:function(d){this.attrs===undefined&&(this.attrs={});if(d){for(var c in d){this.attrs[c]===undefined&&(this.attrs[c]=d[c])}}},setAttrs:function(e){if(e){for(var d in e){var f="set"+d.charAt(0).toUpperCase()+d.slice(1);Kinetic.Type._isFunction(this[f])?this[f](e[d]):this.setAttr(d,e[d])}}},getVisible:function(){return this.attrs.visible&&this.getParent()&&!this.getParent().getVisible()?!1:this.attrs.visible},getListening:function(){return this.attrs.listening&&this.getParent()&&!this.getParent().getListening()?!1:this.attrs.listening},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},getZIndex:function(){return this.index},getAbsoluteZIndex:function(){function h(a){var e=[];for(var d=0;d<a.length;d++){var c=a[d];i++,c.nodeType!=="Shape"&&(e=e.concat(c.getChildren())),c._id===j._id&&(d=a.length)}e.length>0&&e[0].getLevel()<=g&&h(e)}var g=this.getLevel(),f=this.getStage(),j=this,i=0;return j.nodeType!=="Stage"&&h(j.getStage().getChildren()),i},getLevel:function(){var d=0,c=this.parent;while(c){d++,c=c.parent}return d},setPosition:function(){var b=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("x",b.x),this.setAttr("y",b.y)},getPosition:function(){return{x:this.attrs.x,y:this.attrs.y}},getAbsolutePosition:function(){var d=this.getAbsoluteTransform(),c=this.getOffset();return d.translate(c.x,c.y),d.getTranslation()},setAbsolutePosition:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),d=this._clearTransform();this.attrs.x=d.x,this.attrs.y=d.y,delete d.x,delete d.y;var f=this.getAbsoluteTransform();f.invert(),f.translate(e.x,e.y),e={x:this.attrs.x+f.getTranslation().x,y:this.attrs.y+f.getTranslation().y},this.setPosition(e.x,e.y),this._setTransform(d)},move:function(){var e=Kinetic.Type._getXY([].slice.call(arguments)),d=this.getX(),f=this.getY();e.x!==undefined&&(d+=e.x),e.y!==undefined&&(f+=e.y),this.setPosition(d,f)},getRotationDeg:function(){return this.getRotation()*180/Math.PI},setRotationDeg:function(b){this.setRotation(b*Math.PI/180)},rotate:function(b){this.setRotation(this.getRotation()+b)},rotateDeg:function(b){this.setRotation(this.getRotation()+b*Math.PI/180)},moveToTop:function(){var b=this.index;return this.parent.children.splice(b,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0},moveUp:function(){var b=this.index;if(b<this.parent.getChildren().length-1){return this.parent.children.splice(b,1),this.parent.children.splice(b+1,0,this),this.parent._setChildrenIndices(),!0}},moveDown:function(){var b=this.index;if(b>0){return this.parent.children.splice(b,1),this.parent.children.splice(b-1,0,this),this.parent._setChildrenIndices(),!0}},moveToBottom:function(){var b=this.index;if(b>0){return this.parent.children.splice(b,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0}},setZIndex:function(d){var c=this.index;this.parent.children.splice(c,1),this.parent.children.splice(d,0,this),this.parent._setChildrenIndices()},getAbsoluteOpacity:function(){var b=this.getOpacity();return this.getParent()&&(b*=this.getParent().getAbsoluteOpacity()),b},moveTo:function(d){var c=this.parent;c.children.splice(this.index,1),c._setChildrenIndices(),d.children.push(this),this.index=d.children.length-1,this.parent=d,d._setChildrenIndices()},toObject:function(){var f={},e=Kinetic.Type;f.attrs={};for(var h in this.attrs){var g=this.attrs[h];!e._isFunction(g)&&!e._isElement(g)&&(!e._isObject(g)||!e._hasMethods(g))&&(f.attrs[h]=g)}return f.nodeType=this.nodeType,f.shapeType=this.shapeType,f},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},getLayer:function(){return this.getParent().getLayer()},getStage:function(){return this.getParent()?this.getParent().getStage():undefined},simulate:function(d,c){this._handleEvent(d,c||{})},fire:function(d,c){this._executeHandlers(d,c||{})},getAbsoluteTransform:function(){var h=new Kinetic.Transform,g=[],l=this.parent;g.unshift(this);while(l){g.unshift(l),l=l.parent}for(var k=0;k<g.length;k++){var j=g[k],i=j.getTransform();h.multiply(i)}return h},getTransform:function(){var b=new Kinetic.Transform;return(this.attrs.x!==0||this.attrs.y!==0)&&b.translate(this.attrs.x,this.attrs.y),this.attrs.rotation!==0&&b.rotate(this.attrs.rotation),(this.attrs.scale.x!==1||this.attrs.scale.y!==1)&&b.scale(this.attrs.scale.x,this.attrs.scale.y),this.attrs.offset&&(this.attrs.offset.x!==0||this.attrs.offset.y!==0)&&b.translate(-1*this.attrs.offset.x,-1*this.attrs.offset.y),b},clone:function(i){var h=this.shapeType||this.nodeType,n=new Kinetic[h](this.attrs);for(var m in this.eventListeners){var l=this.eventListeners[m];for(var k=0;k<l.length;k++){var j=l[k];j.name.indexOf("kinetic")<0&&(n.eventListeners[m]||(n.eventListeners[m]=[]),n.eventListeners[m].push(j))}}return n.setAttrs(i),n},toDataURL:function(f){var e=f&&f.mimeType?f.mimeType:null,h=f&&f.quality?f.quality:null,g;return f&&f.width&&f.height?g=new Kinetic.Canvas(f.width,f.height):(g=this.getStage().bufferCanvas,g.clear()),this.draw(g),g.toDataURL(e,h)},toImage:function(b){Kinetic.Type._getImage(this.toDataURL(b),function(a){b.callback(a)})},setOffset:function(){var b=Kinetic.Type._getXY([].slice.call(arguments));b.x===undefined&&(b.x=this.getOffset().x),b.y===undefined&&(b.y=this.getOffset().y),this.setAttr("offset",b)},setScale:function(){var b=Kinetic.Type._getXY([].slice.call(arguments));b.x===undefined&&(b.x=this.getScale().x),b.y===undefined&&(b.y=this.getScale().y),this.setAttr("scale",b)},setSize:function(){var b=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(b.width),this.setHeight(b.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},_get:function(b){return this.nodeType===b?[this]:[]},_off:function(e,d){for(var f=0;f<this.eventListeners[e].length;f++){if(this.eventListeners[e][f].name===d){this.eventListeners[e].splice(f,1);if(this.eventListeners[e].length===0){delete this.eventListeners[e];break}f--}}},_clearTransform:function(){var b={x:this.attrs.x,y:this.attrs.y,rotation:this.attrs.rotation,scale:{x:this.attrs.scale.x,y:this.attrs.scale.y},offset:{x:this.attrs.offset.x,y:this.attrs.offset.y}};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scale={x:1,y:1},this.attrs.offset={x:0,y:0},b},_setTransform:function(d){for(var c in d){this.attrs[c]=d[c]}},_fireBeforeChangeEvent:function(e,d,f){this._handleEvent("before"+e.toUpperCase()+"Change",{oldVal:d,newVal:f})},_fireChangeEvent:function(e,d,f){this._handleEvent(e+"Change",{oldVal:d,newVal:f})},setAttr:function(e,d){if(d!==undefined){var f=this.attrs[e];this._fireBeforeChangeEvent(e,f,d),this.attrs[e]=d,this._fireChangeEvent(e,f,d)}},_handleEvent:function(h,g,l){g&&this.nodeType==="Shape"&&(g.shape=this);var k=this.getStage(),j=this.eventListeners,i=!0;h==="mouseenter"&&l&&this._id===l._id?i=!1:h==="mouseleave"&&l&&this._id===l._id&&(i=!1),i&&(j[h]&&this.fire(h,g),g&&!g.cancelBubble&&this.parent&&(l&&l.parent?this._handleEvent.call(this.parent,h,g,l.parent):this._handleEvent.call(this.parent,h,g)))},_executeHandlers:function(f,e){var h=this.eventListeners[f];for(var g=0;g<h.length;g++){h[g].handler.apply(this,[e])}},_shouldDraw:function(b){return this.isVisible()&&(!b||b.name!=="buffer"||this.getListening())}},Kinetic.Node.addSetters=function(f,e){for(var d=0;d<e.length;d++){var g=e[d];this._addSetter(f,g)}},Kinetic.Node.addGetters=function(f,e){for(var d=0;d<e.length;d++){var g=e[d];this._addGetter(f,g)}},Kinetic.Node.addGettersSetters=function(c,b){this.addSetters(c,b),this.addGetters(c,b)},Kinetic.Node._addSetter=function(f,e){var d=this,g="set"+e.charAt(0).toUpperCase()+e.slice(1);f.prototype[g]=function(a){this.setAttr(e,a)}},Kinetic.Node._addGetter=function(f,e){var d=this,g="get"+e.charAt(0).toUpperCase()+e.slice(1);f.prototype[g]=function(a){return this.attrs[e]}},Kinetic.Node.create=function(d,c){return this._createNode(JSON.parse(d),c)},Kinetic.Node._createNode=function(g,f){var j;g.nodeType==="Shape"?g.shapeType===undefined?j="Shape":j=g.shapeType:j=g.nodeType,f&&(g.attrs.container=f);var i=new Kinetic[j](g.attrs);if(g.children){for(var h=0;h<g.children.length;h++){i.add(this._createNode(g.children[h]))}}return i},Kinetic.Node.addGettersSetters(Kinetic.Node,["x","y","rotation","opacity","name","id"]),Kinetic.Node.addGetters(Kinetic.Node,["scale","offset"]),Kinetic.Node.addSetters(Kinetic.Node,["width","height","listening","visible"]),Kinetic.Node.prototype.isListening=Kinetic.Node.prototype.getListening,Kinetic.Node.prototype.isVisible=Kinetic.Node.prototype.getVisible,function(){var d=["on","off"];for(var c=0;c<d.length;c++){(function(a){var e=d[a];Kinetic.Collection.prototype[e]=function(){var b=[].slice.call(arguments);b.unshift(e),this.apply.apply(this,b)}})(c)}}(),Kinetic.DD={anim:new Kinetic.Animation,moving:!1,offset:{x:0,y:0}},Kinetic.DD._startDrag=function(h){var g=Kinetic.DD,l=g.node;if(l){var k=l.getStage().getUserPosition(),j=l.attrs.dragBoundFunc,i={x:k.x-g.offset.x,y:k.y-g.offset.y};j!==undefined&&(i=j.call(l,i,h)),l.setAbsolutePosition(i),g.moving||(g.moving=!0,g.node._handleEvent("dragstart",h)),g.node._handleEvent("dragmove",h)}},Kinetic.DD._endDrag=function(e){var d=Kinetic.DD,f=d.node;f&&(f.nodeType==="Stage"?f.draw():f.getLayer().draw(),d.moving&&(d.moving=!1,f._handleEvent("dragend",e))),d.node=null,d.anim.stop()},Kinetic.Node.prototype.setDraggable=function(b){this.setAttr("draggable",b),this._dragChange()},Kinetic.Node.prototype.getDraggable=function(){return this.attrs.draggable},Kinetic.Node.prototype.isDragging=function(){var b=Kinetic.DD;return b.node&&b.node._id===this._id&&b.moving},Kinetic.Node.prototype._listenDrag=function(){this._dragCleanup();var b=this;this.on("mousedown.kinetic touchstart.kinetic",function(a){b._initDrag()})},Kinetic.Node.prototype._initDrag=function(){var h=Kinetic.DD,g=this.getStage(),l=g.getUserPosition();if(l){var k=this.getTransform().getTranslation(),j=this.getAbsoluteTransform().getTranslation(),i=this.getAbsolutePosition();h.node=this,h.offset.x=l.x-i.x,h.offset.y=l.y-i.y,this.nodeType==="Stage"?h.anim.node=this:h.anim.node=this.getLayer(),h.anim.start()}},Kinetic.Node.prototype._dragChange=function(){if(this.attrs.draggable){this._listenDrag()}else{this._dragCleanup();var d=this.getStage(),c=Kinetic.DD;d&&c.node&&c.node._id===this._id&&c._endDrag()}},Kinetic.Node.prototype._dragCleanup=function(){this.off("mousedown.kinetic"),this.off("touchstart.kinetic")},Kinetic.Node.prototype.isDraggable=Kinetic.Node.prototype.getDraggable,Kinetic.Node.addGettersSetters(Kinetic.Node,["dragBoundFunc"]),Kinetic.Transition=function(j,i){function o(d,c,r,q){for(var h in d){h!=="duration"&&h!=="easing"&&h!=="callback"&&(Kinetic.Type._isObject(d[h])?(r[h]={},o(d[h],c[h],r[h],q)):p._add(p._getTween(c,h,d[h],r,q)))}}this.node=j,this.config=i,this.tweens=[];var p=this,n={};o(i,j.attrs,n,n);var m=0;for(var l=0;l<this.tweens.length;l++){var k=this.tweens[l];k.onFinished=function(){m++,m>=p.tweens.length&&p.onFinished()}}},Kinetic.Transition.prototype={start:function(){for(var b=0;b<this.tweens.length;b++){this.tweens[b].start()}},stop:function(){for(var b=0;b<this.tweens.length;b++){this.tweens[b].stop()}},resume:function(){for(var b=0;b<this.tweens.length;b++){this.tweens[b].resume()}},_onEnterFrame:function(){for(var b=0;b<this.tweens.length;b++){this.tweens[b].onEnterFrame()}},_add:function(b){this.tweens.push(b)},_getTween:function(r,q,p,o,n){var m=this.config,l=this.node,k=m.easing;k===undefined&&(k="linear");var j=new Kinetic.Tween(l,function(b){o[q]=b,l.setAttrs(n)},Kinetic.Tweens[k],r[q],p,m.duration);return j}},Kinetic.Node.prototype.transitionTo=function(f){this.transAnim||(this.transAnim=new Kinetic.Animation);var e=this.nodeType==="Stage"?this:this.getLayer(),h=this,g=new Kinetic.Transition(this,f);return this.transAnim.func=function(){g._onEnterFrame()},this.transAnim.node=e,g.onFinished=function(){h.transAnim.stop(),f.callback&&f.callback()},g.start(),this.transAnim.start(),g},Kinetic.Container=function(b){this._containerInit(b)},Kinetic.Container.prototype={_containerInit:function(b){this.children=[],Kinetic.Node.call(this,b)},getChildren:function(){return this.children},removeChildren:function(){while(this.children.length>0){this.children[0].remove()}},add:function(e){e._id=Kinetic.Global.idCounter++,e.index=this.children.length,e.parent=this,this.children.push(e);var d=e.getStage();if(!d){Kinetic.Global._addTempNode(e)}else{d._addId(e),d._addName(e);var f=Kinetic.Global;f._pullNodes(d)}return this},get:function(i){var h=new Kinetic.Collection;if(i.charAt(0)==="#"){var n=this._getNodeById(i.slice(1));n&&h.push(n)}else{if(i.charAt(0)==="."){var m=this._getNodesByName(i.slice(1));Kinetic.Collection.apply(h,m)}else{var l=[],k=this.getChildren();for(var j=0;j<k.length;j++){l=l.concat(k[j]._get(i))}Kinetic.Collection.apply(h,l)}}return h},_getNodeById:function(d){var c=this.getStage();return c.ids[d]!==undefined&&this.isAncestorOf(c.ids[d])?c.ids[d]:null},_getNodesByName:function(d){var c=this.getStage().names[d]||[];return this._getDescendants(c)},_get:function(f){var e=Kinetic.Node.prototype._get.call(this,f),h=this.getChildren();for(var g=0;g<h.length;g++){e=e.concat(h[g]._get(f))}return e},toObject:function(){var f=Kinetic.Node.prototype.toObject.call(this);f.children=[];var e=this.getChildren();for(var h=0;h<e.length;h++){var g=e[h];f.children.push(g.toObject())}return f},_getDescendants:function(f){var e=[];for(var h=0;h<f.length;h++){var g=f[h];this.isAncestorOf(g)&&e.push(g)}return e},isAncestorOf:function(d){var c=d.getParent();while(c){if(c._id===this._id){return !0}c=c.getParent()}return !1},clone:function(e){var d=Kinetic.Node.prototype.clone.call(this,e);for(var f in this.children){d.add(this.children[f].clone())}return d},getIntersections:function(){var g=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),f=[],j=this.get("Shape");for(var i=0;i<j.length;i++){var h=j[i];h.isVisible()&&h.intersects(g)&&f.push(h)}return f},_setChildrenIndices:function(){for(var b=0;b<this.children.length;b++){this.children[b].index=b}},draw:function(f){if(Kinetic.Node.prototype._shouldDraw.call(this,f)){var e=this.children,h=e.length;for(var g=0;g<h;g++){e[g].draw(f)}}}},Kinetic.Global.extend(Kinetic.Container,Kinetic.Node),Kinetic.Stage=function(b){this._initStage(b)},Kinetic.Stage.prototype={_initStage:function(d){this.setDefaultAttrs({width:400,height:200}),Kinetic.Container.call(this,d),this._setStageDefaultProperties(),this._id=Kinetic.Global.idCounter++,this._buildDOM(),this._bindContentEvents();var c=Kinetic.Global;c.stages.push(this),this._addId(this),this._addName(this)},setContainer:function(b){typeof b=="string"&&(b=document.getElementById(b)),this.setAttr("container",b)},setHeight:function(b){Kinetic.Node.prototype.setHeight.call(this,b),this._resizeDOM()},setWidth:function(b){Kinetic.Node.prototype.setWidth.call(this,b),this._resizeDOM()},clear:function(){var d=this.children;for(var c=0;c<d.length;c++){d[c].clear()}},reset:function(){this.removeChildren(),this._setStageDefaultProperties(),this.setAttrs(this.defaultNodeAttrs)},getMousePosition:function(b){return this.mousePos},getTouchPosition:function(b){return this.touchPos},getUserPosition:function(b){return this.getTouchPosition()||this.getMousePosition()},getStage:function(){return this},getDOM:function(){return this.content},toDataURL:function(r){function j(f){var c=k[f],b=c.toDataURL(),a=new Image;a.onload=function(){l.drawImage(a,0,0),f<k.length-1?j(f+1):r.callback(m.toDataURL(q,p))},a.src=b}var q=r&&r.mimeType?r.mimeType:null,p=r&&r.quality?r.quality:null,o=r&&r.width?r.width:this.attrs.width,n=r&&r.height?r.height:this.attrs.height,m=new Kinetic.Canvas(o,n),l=m.getContext(),k=this.children;j(0)},toImage:function(b){this.toDataURL({callback:function(a){Kinetic.Type._getImage(a,function(c){b.callback(c)})}})},getIntersection:function(i){var h,n=this.getChildren();for(var m=n.length-1;m>=0;m--){var l=n[m];if(l.isVisible()&&l.isListening()){var k=l.bufferCanvas.context.getImageData(Math.round(i.x),Math.round(i.y),1,1).data;if(k[3]===255){var j=Kinetic.Type._rgbToHex(k[0],k[1],k[2]);return h=Kinetic.Global.shapes[j],{shape:h,pixel:k}}if(k[0]>0||k[1]>0||k[2]>0||k[3]>0){return{pixel:k}}}}return null},_getNodeById:function(b){return this.ids[b]||null},_getNodesByName:function(b){return this.names[b]||[]},_resizeDOM:function(){if(this.content){var g=this.attrs.width,f=this.attrs.height;this.content.style.width=g+"px",this.content.style.height=f+"px",this.bufferCanvas.setSize(g,f);var j=this.children;for(var i=0;i<j.length;i++){var h=j[i];h.getCanvas().setSize(g,f),h.bufferCanvas.setSize(g,f),h.draw()}}},add:function(b){return Kinetic.Container.prototype.add.call(this,b),b.canvas.setSize(this.attrs.width,this.attrs.height),b.bufferCanvas.setSize(this.attrs.width,this.attrs.height),b.draw(),this.content.appendChild(b.canvas.element),this},_setUserPosition:function(b){b||(b=window.event),this._setMousePosition(b),this._setTouchPosition(b)},_bindContentEvents:function(){var g=Kinetic.Global,f=this,j=["mousedown","mousemove","mouseup","mouseout","touchstart","touchmove","touchend"];for(var i=0;i<j.length;i++){var h=j[i];(function(){var b=h;f.content.addEventListener(b,function(a){f["_"+b](a)},!1)})()}},_mouseout:function(e){this._setUserPosition(e);var d=Kinetic.DD,f=this.targetShape;f&&(!d||!d.moving)&&(f._handleEvent("mouseout",e),f._handleEvent("mouseleave",e),this.targetShape=null),this.mousePos=undefined,d&&d._endDrag(e)},_mousemove:function(f){this._setUserPosition(f);var e=Kinetic.DD,h=this.getIntersection(this.getUserPosition());if(h){var g=h.shape;g&&(!!e&&!!e.moving||h.pixel[3]!==255||!!this.targetShape&&this.targetShape._id===g._id?g._handleEvent("mousemove",f):(this.targetShape&&(this.targetShape._handleEvent("mouseout",f,g),this.targetShape._handleEvent("mouseleave",f,g)),g._handleEvent("mouseover",f,this.targetShape),g._handleEvent("mouseenter",f,this.targetShape),this.targetShape=g))}else{this.targetShape&&(!e||!e.moving)&&(this.targetShape._handleEvent("mouseout",f),this.targetShape._handleEvent("mouseleave",f),this.targetShape=null)}e&&e._startDrag(f)},_mousedown:function(e){this._setUserPosition(e);var d=this.getIntersection(this.getUserPosition());if(d&&d.shape){var f=d.shape;this.clickStart=!0,f._handleEvent("mousedown",e)}Kinetic.DD&&this.attrs.draggable&&this._initDrag()},_mouseup:function(g){this._setUserPosition(g);var f=Kinetic.DD,j=this.getIntersection(this.getUserPosition()),i=this;if(j&&j.shape){var h=j.shape;h._handleEvent("mouseup",g),this.clickStart&&(!f||!f.moving||!f.node)&&(h._handleEvent("click",g),this.inDoubleClickWindow&&h._handleEvent("dblclick",g),this.inDoubleClickWindow=!0,setTimeout(function(){i.inDoubleClickWindow=!1},this.dblClickWindow))}this.clickStart=!1,f&&f._endDrag(g)},_touchstart:function(e){this._setUserPosition(e),e.preventDefault();var d=this.getIntersection(this.getUserPosition());if(d&&d.shape){var f=d.shape;this.tapStart=!0,f._handleEvent("touchstart",e)}Kinetic.DD&&this.attrs.draggable&&this._initDrag()},_touchend:function(g){this._setUserPosition(g);var f=Kinetic.DD,j=this.getIntersection(this.getUserPosition()),i=this;if(j&&j.shape){var h=j.shape;h._handleEvent("touchend",g),this.tapStart&&(!f||!f.moving||!f.node)&&(h._handleEvent("tap",g),this.inDoubleClickWindow&&h._handleEvent("dbltap",g),this.inDoubleClickWindow=!0,setTimeout(function(){i.inDoubleClickWindow=!1},this.dblClickWindow))}this.tapStart=!1,f&&f._endDrag(g)},_touchmove:function(f){this._setUserPosition(f);var e=Kinetic.DD;f.preventDefault();var h=this.getIntersection(this.getUserPosition());if(h&&h.shape){var g=h.shape;g._handleEvent("touchmove",f)}e&&e._startDrag(f)},_setMousePosition:function(e){var d=e.clientX-this._getContentPosition().left,f=e.clientY-this._getContentPosition().top;this.mousePos={x:d,y:f}},_setTouchPosition:function(f){if(f.touches!==undefined&&f.touches.length===1){var e=f.touches[0],h=e.clientX-this._getContentPosition().left,g=e.clientY-this._getContentPosition().top;this.touchPos={x:h,y:g}}},_getContentPosition:function(){var b=this.content.getBoundingClientRect();return{top:b.top,left:b.left}},_buildDOM:function(){this.content=document.createElement("div"),this.content.style.position="relative",this.content.style.display="inline-block",this.content.className="kineticjs-content",this.attrs.container.appendChild(this.content),this.bufferCanvas=new Kinetic.Canvas({width:this.attrs.width,height:this.attrs.height}),this._resizeDOM()},_addId:function(b){b.attrs.id!==undefined&&(this.ids[b.attrs.id]=b)},_removeId:function(b){b!==undefined&&delete this.ids[b]},_addName:function(d){var c=d.attrs.name;c!==undefined&&(this.names[c]===undefined&&(this.names[c]=[]),this.names[c].push(d))},_removeName:function(g,f){if(g!==undefined){var j=this.names[g];if(j!==undefined){for(var i=0;i<j.length;i++){var h=j[i];h._id===f&&j.splice(i,1)}j.length===0&&delete this.names[g]}}},_onContent:function(g,f){var j=g.split(" ");for(var i=0;i<j.length;i++){var h=j[i];this.content.addEventListener(h,f,!1)}},_setStageDefaultProperties:function(){this.nodeType="Stage",this.dblClickWindow=400,this.targetShape=null,this.mousePos=undefined,this.clickStart=!1,this.touchPos=undefined,this.tapStart=!1,this.ids={},this.names={}}},Kinetic.Global.extend(Kinetic.Stage,Kinetic.Container),Kinetic.Node.addGetters(Kinetic.Stage,["container"]),Kinetic.Layer=function(b){this._initLayer(b)},Kinetic.Layer.prototype={_initLayer:function(b){this.setDefaultAttrs({clearBeforeDraw:!0}),this.nodeType="Layer",this.beforeDrawFunc=undefined,this.afterDrawFunc=undefined,this.canvas=new Kinetic.Canvas,this.canvas.getElement().style.position="absolute",this.bufferCanvas=new Kinetic.Canvas,this.bufferCanvas.name="buffer",Kinetic.Container.call(this,b)},draw:function(f){this.beforeDrawFunc!==undefined&&this.beforeDrawFunc.call(this);var e=[];f?e.push(f):(e.push(this.getCanvas()),e.push(this.bufferCanvas));var h=e.length;for(var g=0;g<h;g++){var f=e[g];Kinetic.Node.prototype._shouldDraw.call(this,f)&&(this.attrs.clearBeforeDraw&&f.clear(),Kinetic.Container.prototype.draw.call(this,f))}this.afterDrawFunc!==undefined&&this.afterDrawFunc.call(this)},drawBuffer:function(){this.draw(this.bufferCanvas)},drawScene:function(){this.draw(this.getCanvas())},beforeDraw:function(b){this.beforeDrawFunc=b},afterDraw:function(b){this.afterDrawFunc=b},getCanvas:function(){return this.canvas},getContext:function(){return this.canvas.context},clear:function(){this.getCanvas().clear()},setVisible:function(b){Kinetic.Node.prototype.setVisible.call(this,b),b?(this.canvas.element.style.display="block",this.bufferCanvas.element.style.display="block"):(this.canvas.element.style.display="none",this.bufferCanvas.element.style.display="none")},setZIndex:function(d){Kinetic.Node.prototype.setZIndex.call(this,d);var c=this.getStage();c&&(c.content.removeChild(this.canvas.element),d<c.getChildren().length-1?c.content.insertBefore(this.canvas.element,c.getChildren()[d+1].canvas.element):c.content.appendChild(this.canvas.element))},moveToTop:function(){Kinetic.Node.prototype.moveToTop.call(this);var b=this.getStage();b&&(b.content.removeChild(this.canvas.element),b.content.appendChild(this.canvas.element))},moveUp:function(){if(Kinetic.Node.prototype.moveUp.call(this)){var b=this.getStage();b&&(b.content.removeChild(this.canvas.element),this.index<b.getChildren().length-1?b.content.insertBefore(this.canvas.element,b.getChildren()[this.index+1].canvas.element):b.content.appendChild(this.canvas.element))}},moveDown:function(){if(Kinetic.Node.prototype.moveDown.call(this)){var d=this.getStage();if(d){var c=d.getChildren();d.content.removeChild(this.canvas.element),d.content.insertBefore(this.canvas.element,c[this.index+1].canvas.element)}}},moveToBottom:function(){if(Kinetic.Node.prototype.moveToBottom.call(this)){var d=this.getStage();if(d){var c=d.getChildren();d.content.removeChild(this.canvas.element),d.content.insertBefore(this.canvas.element,c[1].canvas.element)}}},getLayer:function(){return this},toDataURL:function(g){var f,j=g&&g.mimeType?g.mimeType:null,i=g&&g.quality?g.quality:null;if(!this.isVisible()){var h=this.getStage();f=new Kinetic.Canvas(h.getWidth(),h.getHeight())}else{g&&g.width&&g.height?(f=new Kinetic.Canvas(g.width,g.height),this.draw(f)):f=this.getCanvas()}return f.toDataURL(j,i)},remove:function(){Kinetic.Node.prototype.remove.call(this);try{this.getStage().content.removeChild(this.canvas.element)}catch(b){Kinetic.Global.warn("unable to remove layer scene canvas element from the document")}}},Kinetic.Global.extend(Kinetic.Layer,Kinetic.Container),Kinetic.Node.addGettersSetters(Kinetic.Layer,["clearBeforeDraw"]),Kinetic.Group=function(b){this._initGroup(b)},Kinetic.Group.prototype={_initGroup:function(b){this.nodeType="Group",Kinetic.Container.call(this,b)}},Kinetic.Global.extend(Kinetic.Group,Kinetic.Container),Kinetic.Shape=function(b){this._initShape(b)},Kinetic.Shape.prototype={_initShape:function(e){this.nodeType="Shape",this.appliedShadow=!1;var d=Kinetic.Global.shapes,f;for(;;){f=Kinetic.Type._getRandomColorKey();if(f&&!(f in d)){break}}this.colorKey=f,d[f]=this,Kinetic.Node.call(this,e)},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},stroke:function(g){var f=this.getStrokeWidth(),j=this.getStroke();if(j||f){var i=Kinetic.Global,h=!1;g.save(),this.attrs.shadow&&!this.appliedShadow&&(h=this._applyShadow(g)),g.lineWidth=f||2,g.strokeStyle=j||"black",g.stroke(g),g.restore(),h&&this.stroke(g)}},_getFillType:function(b){return b?Kinetic.Type._isString(b)?"COLOR":b.image?"PATTERN":b.start&&b.end&&!b.start.radius&&!b.end.radius?"LINEAR_GRADIENT":b.start&&b.end&&Kinetic.Type._isNumber(b.start.radius)&&Kinetic.Type._isNumber(b.end.radius)?"RADIAL_GRADIENT":"UNKNOWN":undefined},fill:function(u){var s=!1,r=this.getFill(),q=this._getFillType(r);if(r){u.save(),this.attrs.shadow&&!this.appliedShadow&&(s=this._applyShadow(u));var p=r.start,o=r.end;switch(q){case"COLOR":u.fillStyle=r,u.fill(u);break;case"PATTERN":var n=r.repeat?r.repeat:"repeat";r.scale&&u.scale(r.scale.x,r.scale.y),r.offset&&u.translate(r.offset.x,r.offset.y),u.fillStyle=u.createPattern(r.image,n),u.fill(u);break;case"LINEAR_GRADIENT":var m=u.createLinearGradient(p.x,p.y,o.x,o.y),l=r.colorStops;for(var k=0;k<l.length;k+=2){m.addColorStop(l[k],l[k+1])}u.fillStyle=m,u.fill(u);break;case"RADIAL_GRADIENT":var m=u.createRadialGradient(p.x,p.y,p.radius,o.x,o.y,o.radius),l=r.colorStops;for(var k=0;k<l.length;k+=2){m.addColorStop(l[k],l[k+1])}u.fillStyle=m,u.fill(u);break;default:u.fillStyle="black",u.fill(u)}u.restore()}s&&this.fill(u)},fillText:function(e,d){var f=!1;this.attrs.textFill&&(e.save(),this.attrs.shadow&&!this.appliedShadow&&(f=this._applyShadow(e)),e.fillStyle=this.attrs.textFill,e.fillText(d,0,0),e.restore()),f&&this.fillText(e,d,0,0)},strokeText:function(g,f){var j=!1;if(this.attrs.textStroke||this.attrs.textStrokeWidth){g.save(),this.attrs.shadow&&!this.appliedShadow&&(j=this._applyShadow(g));var i=this.attrs.textStroke?this.attrs.textStroke:"black",h=this.attrs.textStrokeWidth?this.attrs.textStrokeWidth:2;g.lineWidth=h,g.strokeStyle=i,g.strokeText(f,0,0),g.restore()}j&&this.strokeText(g,f,0,0)},drawImage:function(){var e=!1,d=arguments[0];d.save();var f=Array.prototype.slice.call(arguments);if(f.length===6||f.length===10){this.attrs.shadow&&!this.appliedShadow&&(e=this._applyShadow(d)),f.length===6?d.drawImage(f[1],f[2],f[3],f[4],f[5]):d.drawImage(f[1],f[2],f[3],f[4],f[5],f[6],f[7],f[8],f[9])}d.restore(),e&&this.drawImage.apply(this,f)},applyOpacity:function(d){var c=this.getAbsoluteOpacity();c!==1&&(d.globalAlpha=c)},applyLineJoin:function(b){this.attrs.lineJoin&&(b.lineJoin=this.attrs.lineJoin)},applyLineCap:function(b){this.attrs.lineCap&&(b.lineCap=this.attrs.lineCap)},setShadow:function(b){b.offset!==undefined&&(b.offset=Kinetic.Type._getXY(b.offset)),this.setAttr("shadow",Kinetic.Type._merge(b,this.getShadow()))},setFill:function(h){var g=this.getFill(),l=this._getFillType(h),k=this._getFillType(g),j=l==="COLOR"||k==="COLOR",i=l===k||l==="UNKNOWN";h.offset!==undefined&&(h.offset=Kinetic.Type._getXY(h.offset)),!j&&i&&(h=Kinetic.Type._merge(h,g)),this.setAttr("fill",h)},setSize:function(){var b=Kinetic.Type._getSize(Array.prototype.slice.call(arguments));this.setWidth(b.width),this.setHeight(b.height)},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},_get:function(b){return this.nodeType===b||this.shapeType===b?[this]:[]},_applyShadow:function(h){var g=this.attrs.shadow;if(g){var l=this.getAbsoluteOpacity(),k=g.color?g.color:"black",j=g.blur?g.blur:5,i=g.offset?g.offset:{x:0,y:0};return g.opacity&&(h.globalAlpha=g.opacity*l),h.shadowColor=k,h.shadowBlur=j,h.shadowOffsetX=i.x,h.shadowOffsetY=i.y,this.appliedShadow=!0,!0}return !1},intersects:function(){var f=Kinetic.Type._getXY(Array.prototype.slice.call(arguments)),e=this.getStage(),h=e.bufferCanvas;h.clear(),this.draw(h);var g=h.context.getImageData(Math.round(f.x),Math.round(f.y),1,1).data;return g[3]>0},remove:function(){Kinetic.Node.prototype.remove.call(this),delete Kinetic.Global.shapes[this.colorKey]},draw:function(C){if(this.attrs.drawFunc&&Kinetic.Node.prototype._shouldDraw.call(this,C)){var B=this.getStage(),A=C.getContext(),z=[],y=this.parent;z.unshift(this);while(y){z.unshift(y),y=y.parent}A.save();for(var x=0;x<z.length;x++){var w=z[x],v=w.getTransform(),u=v.getMatrix();A.transform(u[0],u[1],u[2],u[3],u[4],u[5])}this.applyOpacity(A),this.applyLineJoin(A),this.applyLineCap(A),this.appliedShadow=!1;var s=Kinetic.Global.BUFFER_WHITELIST,r=Kinetic.Global.BUFFER_BLACKLIST,q={};if(C.name==="buffer"){for(var x=0;x<s.length;x++){var p=s[x];q[p]=this.attrs[p];if(this.attrs[p]||p==="fill"&&!this.attrs.stroke&&!("image" in this.attrs)){this.attrs[p]="#"+this.colorKey}}for(var x=0;x<r.length;x++){var p=r[x];q[p]=this.attrs[p],this.attrs[p]=""}"image" in this.attrs&&(q.image=this.attrs.image,this.imageBuffer?this.attrs.image=this.imageBuffer:(this.attrs.image=null,this.attrs.fill="#"+this.colorKey)),A.globalAlpha=1}this.attrs.drawFunc.call(this,C.getContext());if(C.name==="buffer"){var o=s.concat(r);for(var x=0;x<o.length;x++){var p=o[x];this.attrs[p]=q[p]}this.attrs.image=q.image}A.restore()}}},Kinetic.Global.extend(Kinetic.Shape,Kinetic.Node),Kinetic.Node.addGettersSetters(Kinetic.Shape,["stroke","lineJoin","strokeWidth","drawFunc","cornerRadius"]),Kinetic.Node.addGetters(Kinetic.Shape,["shadow","fill"]),Kinetic.Rect=function(b){this._initRect(b)},Kinetic.Rect.prototype={_initRect:function(b){this.setDefaultAttrs({width:0,height:0,cornerRadius:0}),this.shapeType="Rect",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(b){b.beginPath(),this.attrs.cornerRadius===0?b.rect(0,0,this.attrs.width,this.attrs.height):(b.moveTo(this.attrs.cornerRadius,0),b.lineTo(this.attrs.width-this.attrs.cornerRadius,0),b.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),b.lineTo(this.attrs.width,this.attrs.height-this.attrs.cornerRadius),b.arc(this.attrs.width-this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),b.lineTo(this.attrs.cornerRadius,this.attrs.height),b.arc(this.attrs.cornerRadius,this.attrs.height-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),b.lineTo(0,this.attrs.cornerRadius),b.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),b.closePath(),this.fill(b),this.stroke(b)}},Kinetic.Global.extend(Kinetic.Rect,Kinetic.Shape),Kinetic.Circle=function(b){this._initCircle(b)},Kinetic.Circle.prototype={_initCircle:function(b){this.setDefaultAttrs({radius:0}),this.shapeType="Circle",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(b){b.beginPath(),b.arc(0,0,this.getRadius(),0,Math.PI*2,!0),b.closePath(),this.fill(b),this.stroke(b)},getWidth:function(){return this.getRadius()*2},getHeight:function(){return this.getRadius()*2},setWidth:function(b){Kinetic.Node.prototype.setWidth.call(this,b),this.setRadius(b/2)},setHeight:function(b){Kinetic.Node.prototype.setHeight.call(this,b),this.setRadius(b/2)}},Kinetic.Global.extend(Kinetic.Circle,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Circle,["radius"]),Kinetic.Ellipse=function(b){this._initEllipse(b)},Kinetic.Ellipse.prototype={_initEllipse:function(b){this.setDefaultAttrs({radius:{x:0,y:0}}),this.shapeType="Ellipse",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(d){var c=this.getRadius();d.beginPath(),d.save(),c.x!==c.y&&d.scale(1,c.y/c.x),d.arc(0,0,c.x,0,Math.PI*2,!0),d.restore(),d.closePath(),this.fill(d),this.stroke(d)},setRadius:function(){var b=Kinetic.Type._getXY([].slice.call(arguments));this.setAttr("radius",Kinetic.Type._merge(b,this.getRadius()))},getWidth:function(){return this.getRadius().x*2},getHeight:function(){return this.getRadius().y*2},setWidth:function(b){Kinetic.Node.prototype.setWidth.call(this,b),this.setRadius({x:b/2})},setHeight:function(b){Kinetic.Node.prototype.setHeight.call(this,b),this.setRadius({y:b/2})}},Kinetic.Global.extend(Kinetic.Ellipse,Kinetic.Shape),Kinetic.Node.addGetters(Kinetic.Ellipse,["radius"]),Kinetic.Image=function(b){this._initImage(b)},Kinetic.Image.prototype={_initImage:function(d){this.shapeType="Image",d.drawFunc=this.drawFunc,Kinetic.Shape.call(this,d);var c=this;this.on("imageChange",function(b){c._syncSize()}),this._syncSize()},drawFunc:function(i){var h=this.getWidth(),n=this.getHeight();i.beginPath(),i.rect(0,0,h,n),i.closePath(),this.fill(i),this.stroke(i);if(this.attrs.image){if(this.attrs.crop&&this.attrs.crop.width&&this.attrs.crop.height){var m=this.attrs.crop.x?this.attrs.crop.x:0,l=this.attrs.crop.y?this.attrs.crop.y:0,k=this.attrs.crop.width,j=this.attrs.crop.height;this.drawImage(i,this.attrs.image,m,l,k,j,0,0,h,n)}else{this.drawImage(i,this.attrs.image,0,0,h,n)}}},applyFilter:function(h){var g=new Kinetic.Canvas(this.attrs.image.width,this.attrs.image.height),l=g.getContext();l.drawImage(this.attrs.image,0,0);try{var k=l.getImageData(0,0,g.getWidth(),g.getHeight());h.filter(k,h.config);var j=this;Kinetic.Type._getImage(k,function(a){j.setImage(a),h.callback&&h.callback()})}catch(i){Kinetic.Global.warn("Unable to apply filter. "+i.message)}},setCrop:function(){var f=[].slice.call(arguments),e=Kinetic.Type._getXY(f),h=Kinetic.Type._getSize(f),g=Kinetic.Type._merge(e,h);this.setAttr("crop",Kinetic.Type._merge(g,this.getCrop()))},createImageBuffer:function(u){var s=new Kinetic.Canvas(this.attrs.width,this.attrs.height),r=s.getContext();r.drawImage(this.attrs.image,0,0);try{var q=r.getImageData(0,0,s.getWidth(),s.getHeight()),p=q.data,o=Kinetic.Type._hexToRgb(this.colorKey);for(var n=0,m=p.length;n<m;n+=4){p[n]=o.r,p[n+1]=o.g,p[n+2]=o.b}var l=this;Kinetic.Type._getImage(q,function(a){l.imageBuffer=a,u&&u()})}catch(k){Kinetic.Global.warn("Unable to create image buffer.")}},clearImageBuffer:function(){delete this.imageBuffer},_syncSize:function(){this.attrs.image&&(this.attrs.width||this.setWidth(this.attrs.image.width),this.attrs.height||this.setHeight(this.attrs.image.height))}},Kinetic.Global.extend(Kinetic.Image,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Image,["image"]),Kinetic.Node.addGetters(Kinetic.Image,["crop"]),Kinetic.Polygon=function(b){this._initPolygon(b)},Kinetic.Polygon.prototype={_initPolygon:function(b){this.setDefaultAttrs({points:[]}),this.shapeType="Polygon",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(d){d.beginPath(),d.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var c=1;c<this.attrs.points.length;c++){d.lineTo(this.attrs.points[c].x,this.attrs.points[c].y)}d.closePath(),this.fill(d),this.stroke(d)},setPoints:function(b){this.setAttr("points",Kinetic.Type._getPoints(b))}},Kinetic.Global.extend(Kinetic.Polygon,Kinetic.Shape),Kinetic.Node.addGetters(Kinetic.Polygon,["points"]),Kinetic.Text=function(b){this._initText(b)},Kinetic.Text.prototype={_initText:function(g){this.setDefaultAttrs({fontFamily:"Calibri",text:"",fontSize:12,align:"left",verticalAlign:"top",fontStyle:"normal",padding:0,width:"auto",height:"auto",detectionType:"path",cornerRadius:0,lineHeight:1.2}),this.dummyCanvas=document.createElement("canvas"),this.shapeType="Text",g.drawFunc=this.drawFunc,Kinetic.Shape.call(this,g);var f=["fontFamily","fontSize","fontStyle","padding","align","lineHeight","text","width","height"],j=this;for(var i=0;i<f.length;i++){var h=f[i];this.on(h+"Change.kinetic",j._setTextData)}j._setTextData()},drawFunc:function(r){r.beginPath();var q=this.getWidth(),p=this.getHeight();this.attrs.cornerRadius===0?r.rect(0,0,q,p):(r.moveTo(this.attrs.cornerRadius,0),r.lineTo(q-this.attrs.cornerRadius,0),r.arc(q-this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI*3/2,0,!1),r.lineTo(q,p-this.attrs.cornerRadius),r.arc(q-this.attrs.cornerRadius,p-this.attrs.cornerRadius,this.attrs.cornerRadius,0,Math.PI/2,!1),r.lineTo(this.attrs.cornerRadius,p),r.arc(this.attrs.cornerRadius,p-this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI/2,Math.PI,!1),r.lineTo(0,this.attrs.cornerRadius),r.arc(this.attrs.cornerRadius,this.attrs.cornerRadius,this.attrs.cornerRadius,Math.PI,Math.PI*3/2,!1)),r.closePath(),this.fill(r),this.stroke(r);var o=this.attrs.padding,n=this.attrs.lineHeight*this.getTextHeight(),m=this.textArr;r.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,r.textBaseline="middle",r.textAlign="left",r.save(),r.translate(o,0),r.translate(0,o+this.getTextHeight()/2);var l=this.appliedShadow;for(var k=0;k<m.length;k++){var j=m[k];this.appliedShadow=l,r.save(),this.attrs.align==="right"?r.translate(this.getWidth()-this._getTextSize(j).width-o*2,0):this.attrs.align==="center"&&r.translate((this.getWidth()-this._getTextSize(j).width-o*2)/2,0),this.fillText(r,j),this.strokeText(r,j),r.restore(),r.translate(0,n)}r.restore()},setText:function(d){var c=Kinetic.Type._isString(d)?d:d.toString();this.setAttr("text",c)},getWidth:function(){return this.attrs.width==="auto"?this.getTextWidth()+this.attrs.padding*2:this.attrs.width},getHeight:function(){return this.attrs.height==="auto"?this.getTextHeight()*this.textArr.length*this.attrs.lineHeight+this.attrs.padding*2:this.attrs.height},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},_getTextSize:function(f){var e=this.dummyCanvas,h=e.getContext("2d");h.save(),h.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var g=h.measureText(f);return h.restore(),{width:g.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var w=this.attrs.text.split(""),v=[],u=0,s=!0;this.textWidth=0,this.textHeight=this._getTextSize(this.attrs.text).height;var r=this.attrs.lineHeight*this.textHeight;while(w.length>0&&s&&(this.attrs.height==="auto"||r*(u+1)<this.attrs.height-this.attrs.padding*2)){var q=0,p=undefined;s=!1;while(q<w.length){if(w.indexOf("\n")===q){w.splice(q,1),p=w.splice(0,q).join("");break}var o=w.slice(0,q);if(this.attrs.width!=="auto"&&this._getTextSize(o.join("")).width>this.attrs.width-this.attrs.padding*2){if(q==0){break}var n=o.lastIndexOf(" "),m=o.lastIndexOf("-"),l=Math.max(n,m);if(l>=0){p=w.splice(0,1+l).join("");break}p=w.splice(0,q).join("");break}q++,q===w.length&&(p=w.splice(0,q).join(""))}this.textWidth=Math.max(this.textWidth,this._getTextSize(p).width),p!==undefined&&(v.push(p),s=!0),u++}this.textArr=v}},Kinetic.Global.extend(Kinetic.Text,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Text,["fontFamily","fontSize","fontStyle","textFill","textStroke","textStrokeWidth","padding","align","lineHeight"]),Kinetic.Node.addGetters(Kinetic.Text,["text"]),Kinetic.Line=function(b){this._initLine(b)},Kinetic.Line.prototype={_initLine:function(b){this.setDefaultAttrs({points:[],lineCap:"butt",dashArray:[],detectionType:"pixel"}),this.shapeType="Line",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(i){var h={};i.beginPath(),i.moveTo(this.attrs.points[0].x,this.attrs.points[0].y);for(var n=1;n<this.attrs.points.length;n++){var m=this.attrs.points[n].x,l=this.attrs.points[n].y;if(this.attrs.dashArray.length>0){var k=this.attrs.points[n-1].x,j=this.attrs.points[n-1].y;this._dashedLine(i,k,j,m,l,this.attrs.dashArray)}else{i.lineTo(m,l)}}this.stroke(i)},setPoints:function(b){this.setAttr("points",Kinetic.Type._getPoints(b))},_dashedLine:function(G,F,E,D,C,B){var A=B.length,z=D-F,y=C-E,x=z>y,w=x?y/z:z/y;w>9999?w=9999:w<-9999&&(w=-9999);var v=Math.sqrt(z*z+y*y),u=0,s=!0;while(v>=0.1&&u<10000){var r=B[u++%A];r===0&&(r=0.001),r>v&&(r=v);var q=Math.sqrt(r*r/(1+w*w));x?(F+=z<0&&y<0?q*-1:q,E+=z<0&&y<0?w*q*-1:w*q):(F+=z<0&&y<0?w*q*-1:w*q,E+=z<0&&y<0?q*-1:q),G[s?"lineTo":"moveTo"](F,E),v-=r,s=!s}G.moveTo(D,C)}},Kinetic.Global.extend(Kinetic.Line,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Line,["dashArray"]),Kinetic.Node.addGetters(Kinetic.Line,["points"]),Kinetic.Sprite=function(b){this._initSprite(b)},Kinetic.Sprite.prototype={_initSprite:function(d){this.setDefaultAttrs({index:0,frameRate:17}),this.shapeType="Sprite",d.drawFunc=this.drawFunc,Kinetic.Shape.call(this,d),this.anim=new Kinetic.Animation;var c=this;this.on("animationChange.kinetic",function(){c.setIndex(0)})},drawFunc:function(f){var e=this.attrs.animation,h=this.attrs.index,g=this.attrs.animations[e][h];f.beginPath(),f.rect(0,0,g.width,g.height),f.closePath(),this.fill(f),this.stroke(f),this.attrs.image&&(f.beginPath(),f.rect(0,0,g.width,g.height),f.closePath(),this.drawImage(f,this.attrs.image,g.x,g.y,g.width,g.height,0,0,g.width,g.height))},start:function(){var d=this,c=this.getLayer();this.anim.node=c,this.interval=setInterval(function(){var a=d.attrs.index;d._updateIndex(),d.afterFrameFunc&&a===d.afterFrameIndex&&(d.afterFrameFunc(),delete d.afterFrameFunc,delete d.afterFrameIndex)},1000/this.attrs.frameRate),this.anim.start()},stop:function(){this.anim.stop(),clearInterval(this.interval)},afterFrame:function(d,c){this.afterFrameIndex=d,this.afterFrameFunc=c},_updateIndex:function(){var d=this.attrs.index,c=this.attrs.animation;d<this.attrs.animations[c].length-1?this.attrs.index++:this.attrs.index=0}},Kinetic.Global.extend(Kinetic.Sprite,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Sprite,["animation","animations","index"]),Kinetic.Star=function(b){this._initStar(b)},Kinetic.Star.prototype={_initStar:function(b){this.setDefaultAttrs({numPoints:0,innerRadius:0,outerRadius:0}),this.shapeType="Star",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(g){g.beginPath(),g.moveTo(0,0-this.attrs.outerRadius);for(var f=1;f<this.attrs.numPoints*2;f++){var j=f%2===0?this.attrs.outerRadius:this.attrs.innerRadius,i=j*Math.sin(f*Math.PI/this.attrs.numPoints),h=-1*j*Math.cos(f*Math.PI/this.attrs.numPoints);g.lineTo(i,h)}g.closePath(),this.fill(g),this.stroke(g)}},Kinetic.Global.extend(Kinetic.Star,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.Star,["numPoints","innerRadius","outerRadius"]),Kinetic.RegularPolygon=function(b){this._initRegularPolygon(b)},Kinetic.RegularPolygon.prototype={_initRegularPolygon:function(b){this.setDefaultAttrs({radius:0,sides:0}),this.shapeType="RegularPolygon",b.drawFunc=this.drawFunc,Kinetic.Shape.call(this,b)},drawFunc:function(f){f.beginPath(),f.moveTo(0,0-this.attrs.radius);for(var e=1;e<this.attrs.sides;e++){var h=this.attrs.radius*Math.sin(e*2*Math.PI/this.attrs.sides),g=-1*this.attrs.radius*Math.cos(e*2*Math.PI/this.attrs.sides);f.lineTo(h,g)}f.closePath(),this.fill(f),this.stroke(f)}},Kinetic.Global.extend(Kinetic.RegularPolygon,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.RegularPolygon,["radius","sides"]),Kinetic.Path=function(b){this._initPath(b)},Kinetic.Path.prototype={_initPath:function(d){this.shapeType="Path",this.dataArray=[];var c=this;d.drawFunc=this.drawFunc,Kinetic.Shape.call(this,d),this.dataArray=Kinetic.Path.parsePathData(this.attrs.data),this.on("dataChange",function(){c.dataArray=Kinetic.Path.parsePathData(c.attrs.data)})},drawFunc:function(G){var F=this.dataArray;G.beginPath();for(var E=0;E<F.length;E++){var D=F[E].command,C=F[E].points;switch(D){case"L":G.lineTo(C[0],C[1]);break;case"M":G.moveTo(C[0],C[1]);break;case"C":G.bezierCurveTo(C[0],C[1],C[2],C[3],C[4],C[5]);break;case"Q":G.quadraticCurveTo(C[0],C[1],C[2],C[3]);break;case"A":var B=C[0],A=C[1],z=C[2],y=C[3],x=C[4],w=C[5],v=C[6],u=C[7],s=z>y?z:y,r=z>y?1:z/y,q=z>y?y/z:1;G.translate(B,A),G.rotate(v),G.scale(r,q),G.arc(0,0,s,x,x+w,1-u),G.scale(1/r,1/q),G.rotate(-v),G.translate(-B,-A);break;case"z":G.closePath()}}this.fill(G),this.stroke(G)}},Kinetic.Global.extend(Kinetic.Path,Kinetic.Shape),Kinetic.Path.getLineLength=function(f,e,h,g){return Math.sqrt((h-f)*(h-f)+(g-e)*(g-e))},Kinetic.Path.getPointOnLine=function(I,H,G,F,E,D,C){D===undefined&&(D=H),C===undefined&&(C=G);var B=(E-G)/(F-H+1e-8),A=Math.sqrt(I*I/(1+B*B));F<H&&(A*=-1);var z=B*A,y;if((C-G)/(D-H+1e-8)===B){y={x:D+A,y:C+z}}else{var x,w,v=this.getLineLength(H,G,F,E);if(v<1e-8){return undefined}var u=(D-H)*(F-H)+(C-G)*(E-G);u/=v*v,x=H+u*(F-H),w=G+u*(E-G);var s=this.getLineLength(D,C,x,w),r=Math.sqrt(I*I-s*s);A=Math.sqrt(r*r/(1+B*B)),F<H&&(A*=-1),z=B*A,y={x:x+A,y:w+z}}return y},Kinetic.Path.getPointOnCubicBezier=function(E,D,C,B,A,z,y,x,w){function v(b){return b*b*b}function u(b){return 3*b*b*(1-b)}function s(b){return 3*b*(1-b)*(1-b)}function r(b){return(1-b)*(1-b)*(1-b)}var q=x*v(E)+z*u(E)+B*s(E)+D*r(E),p=w*v(E)+y*u(E)+A*s(E)+C*r(E);return{x:q,y:p}},Kinetic.Path.getPointOnQuadraticBezier=function(y,x,w,v,u,s,r){function q(b){return b*b}function p(b){return 2*b*(1-b)}function o(b){return(1-b)*(1-b)}var n=s*q(y)+v*p(y)+x*o(y),m=r*q(y)+u*p(y)+w*o(y);return{x:n,y:m}},Kinetic.Path.getPointOnEllipticalArc=function(r,q,p,o,n,m){var l=Math.cos(m),k=Math.sin(m),j={x:p*Math.cos(n),y:o*Math.sin(n)};return{x:r+(j.x*l-j.y*k),y:q+(j.x*k+j.y*l)}},Kinetic.Path.parsePathData=function(Z){if(!Z){return[]}var Y=Z,X=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];Y=Y.replace(new RegExp(" ","g"),",");for(var W=0;W<X.length;W++){Y=Y.replace(new RegExp(X[W],"g"),"|"+X[W])}var V=Y.split("|"),U=[],T=0,S=0;for(var W=1;W<V.length;W++){var R=V[W],Q=R.charAt(0);R=R.slice(1),R=R.replace(new RegExp(",-","g"),"-"),R=R.replace(new RegExp("-","g"),",-"),R=R.replace(new RegExp("e,-","g"),"e-");var P=R.split(",");P.length>0&&P[0]===""&&P.shift();for(var O=0;O<P.length;O++){P[O]=parseFloat(P[O])}while(P.length>0){if(isNaN(P[0])){break}var N=null,M=[],L=T,K=S;switch(Q){case"l":T+=P.shift(),S+=P.shift(),N="L",M.push(T,S);break;case"L":T=P.shift(),S=P.shift(),M.push(T,S);break;case"m":T+=P.shift(),S+=P.shift(),N="M",M.push(T,S),Q="l";break;case"M":T=P.shift(),S=P.shift(),N="M",M.push(T,S),Q="L";break;case"h":T+=P.shift(),N="L",M.push(T,S);break;case"H":T=P.shift(),N="L",M.push(T,S);break;case"v":S+=P.shift(),N="L",M.push(T,S);break;case"V":S=P.shift(),N="L",M.push(T,S);break;case"C":M.push(P.shift(),P.shift(),P.shift(),P.shift()),T=P.shift(),S=P.shift(),M.push(T,S);break;case"c":M.push(T+P.shift(),S+P.shift(),T+P.shift(),S+P.shift()),T+=P.shift(),S+=P.shift(),N="C",M.push(T,S);break;case"S":var J=T,I=S,H=U[U.length-1];H.command==="C"&&(J=T+(T-H.points[2]),I=S+(S-H.points[3])),M.push(J,I,P.shift(),P.shift()),T=P.shift(),S=P.shift(),N="C",M.push(T,S);break;case"s":var J=T,I=S,H=U[U.length-1];H.command==="C"&&(J=T+(T-H.points[2]),I=S+(S-H.points[3])),M.push(J,I,T+P.shift(),S+P.shift()),T+=P.shift(),S+=P.shift(),N="C",M.push(T,S);break;case"Q":M.push(P.shift(),P.shift()),T=P.shift(),S=P.shift(),M.push(T,S);break;case"q":M.push(T+P.shift(),S+P.shift()),T+=P.shift(),S+=P.shift(),N="Q",M.push(T,S);break;case"T":var J=T,I=S,H=U[U.length-1];H.command==="Q"&&(J=T+(T-H.points[0]),I=S+(S-H.points[1])),T=P.shift(),S=P.shift(),N="Q",M.push(J,I,T,S);break;case"t":var J=T,I=S,H=U[U.length-1];H.command==="Q"&&(J=T+(T-H.points[0]),I=S+(S-H.points[1])),T+=P.shift(),S+=P.shift(),N="Q",M.push(J,I,T,S);break;case"A":var G=P.shift(),F=P.shift(),E=P.shift(),D=P.shift(),C=P.shift(),B=T,A=S;T=P.shift(),S=P.shift(),N="A",M=this.convertEndpointToCenterParameterization(B,A,T,S,D,C,G,F,E);break;case"a":var G=P.shift(),F=P.shift(),E=P.shift(),D=P.shift(),C=P.shift(),B=T,A=S;T+=P.shift(),S+=P.shift(),N="A",M=this.convertEndpointToCenterParameterization(B,A,T,S,D,C,G,F,E)}U.push({command:N||Q,points:M,start:{x:L,y:K},pathLength:this.calcLength(L,K,N||Q,M)})}(Q==="z"||Q==="Z")&&U.push({command:"z",points:[],start:undefined,pathLength:0})}return U},Kinetic.Path.calcLength=function(y,x,w,v){var u,s,r,q=Kinetic.Path;switch(w){case"L":return q.getLineLength(y,x,v[0],v[1]);case"C":u=0,s=q.getPointOnCubicBezier(0,y,x,v[0],v[1],v[2],v[3],v[4],v[5]);for(t=0.01;t<=1;t+=0.01){r=q.getPointOnCubicBezier(t,y,x,v[0],v[1],v[2],v[3],v[4],v[5]),u+=q.getLineLength(s.x,s.y,r.x,r.y),s=r}return u;case"Q":u=0,s=q.getPointOnQuadraticBezier(0,y,x,v[0],v[1],v[2],v[3]);for(t=0.01;t<=1;t+=0.01){r=q.getPointOnQuadraticBezier(t,y,x,v[0],v[1],v[2],v[3]),u+=q.getLineLength(s.x,s.y,r.x,r.y),s=r}return u;case"A":u=0;var p=v[4],o=v[5],n=v[4]+o,m=Math.PI/180;Math.abs(p-n)<m&&(m=Math.abs(p-n)),s=q.getPointOnEllipticalArc(v[0],v[1],v[2],v[3],p,0);if(o<0){for(t=p-m;t>n;t-=m){r=q.getPointOnEllipticalArc(v[0],v[1],v[2],v[3],t,0),u+=q.getLineLength(s.x,s.y,r.x,r.y),s=r}}else{for(t=p+m;t<n;t+=m){r=q.getPointOnEllipticalArc(v[0],v[1],v[2],v[3],t,0),u+=q.getLineLength(s.x,s.y,r.x,r.y),s=r}}return r=q.getPointOnEllipticalArc(v[0],v[1],v[2],v[3],n,0),u+=q.getLineLength(s.x,s.y,r.x,r.y),u}return 0},Kinetic.Path.convertEndpointToCenterParameterization=function(X,W,V,U,T,S,R,Q,P){var O=P*(Math.PI/180),N=Math.cos(O)*(X-V)/2+Math.sin(O)*(W-U)/2,M=-1*Math.sin(O)*(X-V)/2+Math.cos(O)*(W-U)/2,L=N*N/(R*R)+M*M/(Q*Q);L>1&&(R*=Math.sqrt(L),Q*=Math.sqrt(L));var K=Math.sqrt((R*R*Q*Q-R*R*M*M-Q*Q*N*N)/(R*R*M*M+Q*Q*N*N));T==S&&(K*=-1),isNaN(K)&&(K=0);var J=K*R*M/Q,I=K*-Q*N/R,H=(X+V)/2+Math.cos(O)*J-Math.sin(O)*I,G=(W+U)/2+Math.sin(O)*J+Math.cos(O)*I,F=function(b){return Math.sqrt(b[0]*b[0]+b[1]*b[1])},E=function(d,c){return(d[0]*c[0]+d[1]*c[1])/(F(d)*F(c))},D=function(d,c){return(d[0]*c[1]<d[1]*c[0]?-1:1)*Math.acos(E(d,c))},C=D([1,0],[(N-J)/R,(M-I)/Q]),B=[(N-J)/R,(M-I)/Q],A=[(-1*N-J)/R,(-1*M-I)/Q],z=D(B,A);return E(B,A)<=-1&&(z=Math.PI),E(B,A)>=1&&(z=0),S===0&&z>0&&(z-=2*Math.PI),S==1&&z<0&&(z+=2*Math.PI),[H,G,R,Q,C,z,O,S]},Kinetic.Node.addGettersSetters(Kinetic.Path,["data"]),Kinetic.TextPath=function(b){this._initTextPath(b)},Kinetic.TextPath.prototype={_initTextPath:function(g){this.setDefaultAttrs({fontFamily:"Calibri",fontSize:12,fontStyle:"normal",detectionType:"path",text:""}),this.dummyCanvas=document.createElement("canvas"),this.shapeType="TextPath",this.dataArray=[];var f=this;g.drawFunc=this.drawFunc,Kinetic.Shape.call(this,g),this.dataArray=Kinetic.Path.parsePathData(this.attrs.data),this.on("dataChange",function(){f.dataArray=Kinetic.Path.parsePathData(this.attrs.data)});var j=["text","textStroke","textStrokeWidth"];for(var i=0;i<j.length;i++){var h=j[i];this.on(h+"Change",f._setTextData)}f._setTextData()},drawFunc:function(j){var i=this.charArr;j.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily,j.textBaseline="middle",j.textAlign="left",j.save();var p=this.glyphInfo,o=this.appliedShadow;for(var n=0;n<p.length;n++){this.appliedShadow=o,j.save();var m=p[n].p0,l=p[n].p1,k=parseFloat(this.attrs.fontSize);j.translate(m.x,m.y),j.rotate(p[n].rotation),this.fillText(j,p[n].text),this.strokeText(j,p[n].text),j.restore()}j.restore()},getTextWidth:function(){return this.textWidth},getTextHeight:function(){return this.textHeight},setText:function(b){Kinetic.Text.prototype.setText.call(this,b)},_getTextSize:function(f){var e=this.dummyCanvas,h=e.getContext("2d");h.save(),h.font=this.attrs.fontStyle+" "+this.attrs.fontSize+"pt "+this.attrs.fontFamily;var g=h.measureText(f);return h.restore(),{width:g.width,height:parseInt(this.attrs.fontSize,10)}},_setTextData:function(){var E=this,D=this._getTextSize(this.attrs.text);this.textWidth=D.width,this.textHeight=D.height,this.glyphInfo=[];var C=this.attrs.text.split(""),B,A,z,y=-1,x=0,w=function(){x=0;var a=E.dataArray;for(var d=y+1;d<a.length;d++){if(a[d].pathLength>0){return y=d,a[d]}a[d].command=="M"&&(B={x:a[d].points[0],y:a[d].points[1]})}return{}},v=function(J,I){var H=E._getTextSize(J).width,G=0,F=0,i=!1;A=undefined;while(Math.abs(H-G)/H>0.01&&F<25){F++;var h=G;while(z===undefined){z=w(),z&&h+z.pathLength<H&&(h+=z.pathLength,z=undefined)}if(z==={}||B===undefined){return undefined}var f=!1;switch(z.command){case"L":Kinetic.Path.getLineLength(B.x,B.y,z.points[0],z.points[1])>H?A=Kinetic.Path.getPointOnLine(H,B.x,B.y,z.points[0],z.points[1],B.x,B.y):z=undefined;break;case"A":var e=z.points[4],d=z.points[5],a=z.points[4]+d;x===0?x=e+1e-8:H>G?x+=Math.PI/180*d/Math.abs(d):x-=Math.PI/360*d/Math.abs(d),Math.abs(x)>Math.abs(a)&&(x=a,f=!0),A=Kinetic.Path.getPointOnEllipticalArc(z.points[0],z.points[1],z.points[2],z.points[3],x,z.points[6]);break;case"C":x===0?H>z.pathLength?x=1e-8:x=H/z.pathLength:H>G?x+=(H-G)/z.pathLength:x-=(G-H)/z.pathLength,x>1&&(x=1,f=!0),A=Kinetic.Path.getPointOnCubicBezier(x,z.start.x,z.start.y,z.points[0],z.points[1],z.points[2],z.points[3],z.points[4],z.points[5]);break;case"Q":x===0?x=H/z.pathLength:H>G?x+=(H-G)/z.pathLength:x-=(G-H)/z.pathLength,x>1&&(x=1,f=!0),A=Kinetic.Path.getPointOnQuadraticBezier(x,z.start.x,z.start.y,z.points[0],z.points[1],z.points[2],z.points[3])}A!==undefined&&(G=Kinetic.Path.getLineLength(B.x,B.y,A.x,A.y)),f&&(f=!1,z=undefined)}};for(var u=0;u<C.length;u++){v(C[u]);if(B===undefined||A===undefined){break}var s=Kinetic.Path.getLineLength(B.x,B.y,A.x,A.y),r=0,q=Kinetic.Path.getPointOnLine(r+s/2,B.x,B.y,A.x,A.y),p=Math.atan2(A.y-B.y,A.x-B.x);this.glyphInfo.push({transposeX:q.x,transposeY:q.y,text:C[u],rotation:p,p0:B,p1:A}),B=A}}},Kinetic.Global.extend(Kinetic.TextPath,Kinetic.Shape),Kinetic.Node.addGettersSetters(Kinetic.TextPath,["fontFamily","fontSize","fontStyle","textFill","textStroke","textStrokeWidth"]),Kinetic.Node.addGetters(Kinetic.TextPath,["text"]);